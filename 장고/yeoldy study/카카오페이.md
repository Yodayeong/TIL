## 카카오페이



1. 카카오페이 app 생성 및 url 연결

2. index url 생성

   ```python
   #kakaopay/urls.py
   
   from django.urls import path
   from . import views
   
   app_name = 'kakaopay'
   
   urlpatterns = [
       path('', views.index, name="index"),
   ]
   ```

3. index view 생성

   ```python
   #kakaopay/views.py
   
   def django.shortcuts import render
   
   def index(request):
       return render(request, 'kakaopay/index.html')
   ```

4. index.html 생성

   ```html
   <!-- kakaopay/index.html -->
   
   {% extends 'base.html' %}
   
   {% block content %}
   
   <h1>KAKAO PAY</h1>
   <!-- 결제하기 버튼은 input 태그와 동일한 역할을 함 -->
   <form action="" method="post">
       {% csrf_token %}
       <button class="btn btn-warning">카카오페이로 결제하기</button>
   </form>
   
   {% endblock %}
   ```

5. views.py 수정하기

   ```python
   #kakaopay/views.py
   
   from django.shortcuts import render, redirect
   import requests
   
   # Create your views here.
   def index(request):
       if request.method == "POST":
           URL = 'https://kapi.kakao.com/v1/payment/ready'
           headers = {
               "Authorization": "KakaoAK " + "b2fcbb98f1cd8dbadcae7f2981acb9e3",   # 변경불가
               "Content-type": "application/x-www-form-urlencoded;charset=utf-8",  # 변경불가
           }
           params = {
               "cid": "TC0ONETIME",    # 테스트용 코드
               "partner_order_id": "1001",     # 주문번호
               "partner_user_id": "german",    # 유저 아이디
               "item_name": "연어초밥",        # 구매 물품 이름
               "quantity": "1",                # 구매 물품 수량
               "total_amount": "12000",        # 구매 물품 가격
               "tax_free_amount": "0",         # 구매 물품 비과세
               "approval_url": "http://127.0.0.1:8000/kakaopay/approval/",
               "cancel_url": "http://127.0.0.1:8000",
               "fail_url": "http://127.0.0.1:8000",
           }
   
           #requests는 서버 내부 통신을 위한 것
           #요청에 대한 응답을 res 변수에 담는다.
           res = requests.post(URL, headers=headers, params=params)
           #응답 받은 것들 중, tid는 결제 승인 시 필요하므로, 세션에 저장
           #res.json()은 dict 형태이므로, tid라는 키 값을 줌
           request.session['tid'] = res.json()['tid']
           #결제 페이지로 넘어갈 url을 저장
           next_url = res.json()['next_redirect_pc_url']   
           return redirect(next_url)
   
       return render(request, 'kakaopay/index.html')
   ```

6. approval url 생성

   ```python
   #kakaopay/urls.py
   
   from django.urls import path
   from . import views
   
   app_name = 'kakaopay'
   
   urlpatterns = [
       path('', views.index, name="index"),
       path('approval/', views.approval, name="approval"),
   ]
   ```

7. approval view 생성

   ```python
   #kakaopay/views.py
   
   def approval(request):
       URL = 'https://kapi.kakao.com/v1/payment/approve'
       headers = {
           "Authorization": "KakaoAK " + "b2fcbb98f1cd8dbadcae7f2981acb9e3",
           "Content-type": "application/x-www-form-urlencoded;charset=utf-8",
       }
       params = {
           "cid": "TC0ONETIME",    # 테스트용 코드
           "tid": request.session['tid'],  # 결제 요청시 세션에 저장한 tid
           "partner_order_id": "1001",     # 주문번호
           "partner_user_id": "german",    # 유저 아이디
           "pg_token": request.GET.get("pg_token"),     # 쿼리 스트링으로 받은 pg토큰
       }
   
       res = requests.post(URL, headers=headers, params=params)
       #res.json()에서 amount의 total은 amout 변수에 저장
       amount = res.json()['amount']['total']
       res = res.json()
       #res와 amount를 context로 넘겨줌
       context = {
           'res': res,
           'amount': amount,
       }
       return render(request, 'kakaopay/approval.html', context)
   ```

8. approval.html 생성

   ```html
   <!-- kakaopay/approval.html -->
   
   {% extends 'base.html' %}
   
   {% block content %}
   
       <div class="mt-5 pt-5 row justify-content-center">
       <h2 class="text-center my-5 col-12">결제가 완료되었습니다!</h2>
       <div class="col-4 p-5 bg-light">
           <h3 class="text-center my-5">주문 정보</h3>
           <div>
           <div class="my-3 row"><div class="h5 col-6">주문번호</div><div class="h6 col-6 text-right">{{ res.partner_order_id }}</div></div>
           <div class="my-3 row"><div class="h5 col-6">상품명</div><div class="h6 col-6 text-right">{{ res.item_name }}</div></div>
           <div class="my-3 row"><div class="h5 col-6">결제금액</div><div class="h6 col-6 text-right">{{ amount }}원</div></div>
           <div class="my-3 row"><div class="h5 col-6">결제승인시각</div><div class="h6 col-6 text-right">{{ res.approved_at }}</div></div>
           </div>
           <div class="mt-5 pt-3 text-center">
           <a href="{% url 'main' %}" class="btn btn-warning">메인으로 돌아가기</a>
           </div>
   
       </div>
   
       </div>
   
   {% endblock %}
   ```




## 장바구니와 연결

```python
#kakaopay/views.py

def index(request):
    user = User.objects.get(pk=request.user.pk)

    #cart_item_name
    cart_items = list(CartItem.objects.filter(user_id=request.user.pk))
    first_item = str(cart_items[0])
    cart_quantity = int(len(cart_items))
    print(first_item)
    print(cart_quantity, type(cart_quantity))

    #첫 아이템 말고는 외 ~건으로 처리
    if cart_quantity == 1:
        cart_item_name = first_item
    else:
        cart_item_name = first_item + " 외 " + str(cart_quantity-1) + "건"

    #cart_total
    cart_total = 0
    for cart_item in cart_items:
        cart_total += cart_item.product.cost * cart_item.quantity

    if request.method == "POST":
        URL = 'https://kapi.kakao.com/v1/payment/ready'
        headers = {
            "Authorization": "KakaoAK " + "b2fcbb98f1cd8dbadcae7f2981acb9e3",   # 변경불가
            "Content-type": "application/x-www-form-urlencoded;charset=utf-8",  # 변경불가
        }
        params = {
            "cid": "TC0ONETIME",    # 테스트용 코드
            "partner_order_id": "1001",     # 주문번호
            "partner_user_id": "{}".format(user),    # 유저 아이디
            "item_name": "{}".format(cart_item_name),        # 구매 물품 이름
            "quantity": "{}".format(cart_quantity),                # 구매 물품 수량
            "total_amount": "{}".format(cart_total),        # 구매 물품 가격
            "tax_free_amount": "0",         # 구매 물품 비과세
            "approval_url": "http://127.0.0.1:8000/kakaopay/approval/",
            "cancel_url": "http://127.0.0.1:8000",
            "fail_url": "http://127.0.0.1:8000",
        }
        print(params)

        res = requests.post(URL, headers=headers, params=params)
        request.session['tid'] = res.json()['tid']      # 결제 승인시 사용할 tid를 세션에 저장
        next_url = res.json()['next_redirect_pc_url']   # 결제 페이지로 넘어갈 url을 저장
        return redirect(next_url)

    return render(request, 'kakaopay/index.html')
```

=> 한땀한땀 만든거임.. 넘 뿌듯함



## 배송완료 건에 대한 데이터베이스 (OrderList)

- 주문서 OrderList에서 배송지, 이름, 전화번호 등 기본 정보를 입력받고 order_condition=0으로 두기
- 주문이 완료되면 OrderList의 order_condition을 1로 바꾸고, 주문 완료된 상품들의 정보를 추가 저장



- 이때, 카카오페이를 누르기만 하고 결제를 안하면, 
  - 데이터베이스에 저장만 된다.

=> 결제를 할 때, user의 가장 마지막 orderlist에 배송 완료 건을 저장한다.